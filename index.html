<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Flohmarkt Welmlingen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    font-family: 'Segoe UI', sans-serif;
    background: #f0f2f5;
  }
  #map {
    height: 100vh;
    width: 100%;
    box-shadow: 0 5px 25px rgba(0,0,0,0.3);
    border-radius: 10px;
  }
  .title {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(6px);
    padding: 10px 25px;
    border-radius: 16px;
    font-size: 20px;
    font-weight: 700;
    color: #222;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    z-index: 1000;
    pointer-events: none;
  }
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    font-size: 14px;
    padding: 12px;
    background: #ffffffcc;
    backdrop-filter: blur(4px);
  }
  .leaflet-popup-content b {
    font-size: 15px;
    display: block;
    margin-bottom: 6px;
    color: #333;
  }
  .leaflet-popup-content a {
    text-decoration: none;
    color: #1e90ff;
    font-weight: 600;
    transition: color 0.2s ease;
  }
  .leaflet-popup-content a:hover {
    color: #ff7a00;
    text-decoration: underline;
  }
  .user-location {
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 0.7; }
    50% { transform: scale(1.3); opacity: 0.4; }
    100% { transform: scale(1); opacity: 0.7; }
  }
</style>
</head>
<body>
<div class="title">2. Dorfflohmarkt Welmlingen</div>
<div id="map"></div>

<script>
  // Karte erstellen
  var map = L.map('map', { minZoom: 15, maxZoom: 19 }).setView([47.6889638, 7.5597250], 17);

  // Satellitenkarte (Esri)
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics',
    maxZoom: 19
  }).addTo(map);

  // Begrenzung auf Welmlingen
  var bounds = [ [47.685, 7.555], [47.693, 7.565] ];
  map.setMaxBounds(bounds);
  map.on('drag', function() { map.panInsideBounds(bounds, { animate: false }); });

  // Benutzerstandort
  var userCircle, userLat = null, userLon = null;

  // Flohmarktstände
  const flohmarktStaende = [
    { name: "Alte Landstr. 7", lat: 47.6904935, lon: 7.5614855, food: "Fleischkäsweckle, Getränke" },
    { name: "Alte Landstr. 26", lat: 47.6889451, lon: 7.5603436, food: "Crepes" },
    { name: "Am Kirchberg 1", lat: 47.6902198, lon: 7.5590008, food: "Kuchen, Getränke" },
    { name: "Blauenblick 4/2", lat: 47.6889823, lon: 7.5597387, food: "Muffins, Kuchen, Burger, Getränke" },
    { name: "Blauenblick 19", lat: 47.6878812, lon: 7.5592338, food: "Candy- & Popcorn-Bar, Getränke" },
    { name: "Blauenblick 38", lat: 47.6884244, lon: 7.5588452, food: "Waffeln, Muffins, Kaffee" },
    { name: "Freiburger Str. 15", lat: 47.6886621, lon: 7.5622791, food: "Chessiwürscht" },
    { name: "Haselstr. 12", lat: 47.6890721, lon: 7.5639263, food: "Muffins" },
    { name: "Mühlenweg 1", lat: 47.6882229, lon: 7.5598896, food: "Getränke" },
    { name: "Schulstr. 4", lat: 47.6871817, lon: 7.5595188, food: "Getränke" },
    { name: "Schulstr. 11", lat: 47.6872336, lon: 7.5592150, food: "Cookies, Popcorn, Zuckerwatte, Getränke" },
    { name: "Schulstr. 16", lat: 47.6874327, lon: 7.5591496, food: "Würste, Brot, Getränke" },
    { name: "Schulstr. 17", lat: 47.6898783, lon: 7.5623247, food: "Kuchen, Kaffee" },
    { name: "Steingasse 4", lat: 47.6896689, lon: 7.5621933, food: "Waffeln" },
    { name: "Steingasse 5", lat: 47.6895249, lon: 7.5614651, food: "heiße Wienerle, Brot, Getränke" },
    { name: "Steingasse 11", lat: 47.6874422, lon: 7.5629242, food: "Muffins, Kuchen, Lemon Soda" },
    { name: "Walter-Wetzel-Str. 3/1", lat: 47.688825, lon: 7.558832, food: "Essen, Getränke" }
  ];

  // Marker Icon
  var standIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
    iconSize: [32,32],
    iconAnchor: [16,32],
    popupAnchor: [0,-32]
  });

  function createNavigationUrl(destLat, destLon) {
    if (userLat !== null && userLon !== null) {
      return `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLon}&destination=${destLat},${destLon}`;
    } else {
      return `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLon}`;
    }
  }

  function updatePopupContent(marker, stand) {
    const navigationUrl = createNavigationUrl(stand.lat, stand.lon);
    const popupContent = `
      <b>${stand.name}</b><br>
      Angebot: ${stand.food}<br>
      <a href="${navigationUrl}" target="_blank">Navigation</a>
    `;
    marker.setPopupContent(popupContent);
  }

  // Flohmarktmarker
  const markers = [];
  flohmarktStaende.forEach(stand => {
    var marker = L.marker([stand.lat, stand.lon], {icon: standIcon}).addTo(map);
    const popupContent = `
      <b>${stand.name}</b><br>
      Angebot: ${stand.food}<br>
      <a href="#" onclick="openNavigation(${stand.lat}, ${stand.lon}); return false;">Navigation</a>
    `;
    marker.bindPopup(popupContent, {
      autoPan: true,
      autoPanPadding: [20, 20],
      maxWidth: 200,
      closeButton: true
    });
    markers.push({marker: marker, stand: stand});
  });

  window.openNavigation = function(destLat, destLon) {
    const url = createNavigationUrl(destLat, destLon);
    window.open(url, '_blank');
  };

  // Nutzerstandort einmalig setzen (bleibt ruhig)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      userCircle = L.circleMarker([userLat, userLon], {
        radius: 9,
        fillColor: "#007bff",
        color: "#ffffff",
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8,
        className: 'user-location'
      }).addTo(map).bindPopup("Dein Standort", { autoPan: false });

      // Popups der Flohmarktstände aktualisieren
      markers.forEach(({marker, stand}) => {
        updatePopupContent(marker, stand);
      });
    }, function(error) {
      console.error("Fehler bei der Ermittlung des Standorts: ", error);
      userLat = null;
      userLon = null;
    });
  }
</script>
</body>
</html>
