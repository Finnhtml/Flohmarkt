<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Flohmarkt Welmlingen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    font-family: 'Segoe UI', sans-serif;
    background: #f0f2f5;
  }
  #map {
    height: 100vh;
    width: 100%;
    box-shadow: 0 5px 25px rgba(0,0,0,0.3);
    border-radius: 10px;
  }
  .title {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.85);
    -webkit-backdrop-filter: blur(6px);
    backdrop-filter: blur(6px);
    padding: 10px 25px;
    border-radius: 16px;
    font-size: 20px;
    font-weight: 700;
    color: #222;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    z-index: 1000;
    pointer-events: none;
  }
  .designer {
    position: absolute;
    top: 65px; /* Abstand unter dem Titel */
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.4); /* Weniger Deckkraft */
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
    padding: 3px 10px; /* Kleineres Padding */
    border-radius: 10px; /* Etwas kleinerer Radius */
    font-size: 12px; /* Kleinere Schriftgröße */
    font-weight: 500; /* Weniger fetter Text */
    color: #888; /* Hellerer Text */
    z-index: 999;
    pointer-events: none;
  }
  .gps-status {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.9);
    -webkit-backdrop-filter: blur(6px);
    backdrop-filter: blur(6px);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 1000;
    pointer-events: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
    opacity: 0;
  }
  .gps-status.show {
    opacity: 1;
  }
  .gps-status.good {
    color: #28a745;
    border: 2px solid #28a745;
  }
  .gps-status.medium {
    color: #ffc107;
    border: 2px solid #ffc107;
  }
  .gps-status.poor {
    color: #dc3545;
    border: 2px solid #dc3545;
  }
  .gps-status.searching {
    color: #007bff;
    border: 2px solid #007bff;
  }
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    font-size: 14px;
    padding: 12px;
    background: #ffffffcc;
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
  }
  .leaflet-popup-content b {
    font-size: 15px;
    display: block;
    margin-bottom: 6px;
    color: #333;
  }
  .leaflet-popup-content a {
    text-decoration: none;
    color: #1e90ff;
    font-weight: 600;
    transition: color 0.2s ease;
  }
  .leaflet-popup-content a:hover {
    color: #ff7a00;
    text-decoration: underline;
  }
  .user-location {
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 0.7; }
    50% { transform: scale(1.3); opacity: 0.4; }
    100% { transform: scale(1); opacity: 0.7; }
  }
  
  #loader-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #f0f2f5;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    transition: opacity 0.5s ease;
  }
  .loader {
    border: 8px solid #f3f3f3;
    border-top: 8px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 2s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .disclaimer {
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1001;
    color: #666;
    font-size: 10px;
    text-align: center;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
  }
</style>
</head>
<body>

<div id="loader-container">
  <div class="loader"></div>
  <p>Karte wird geladen...</p>
</div>

<div class="title">2. Dorfflohmarkt Welmlingen</div>
<div class="designer">Designt von Finn Wasmer</div>
<div id="map"></div>
<div class="disclaimer">
  Alle Angaben ohne Gewähr.
</div>

<script>
  var map = L.map('map', { minZoom: 15, maxZoom: 19 }).setView([47.6889638, 7.5597250], 17);

  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics',
    maxZoom: 19
  }).addTo(map);

  var bounds = [ [47.685, 7.555], [47.693, 7.565] ];
  map.setMaxBounds(bounds);
  map.on('drag', function() { map.panInsideBounds(bounds, { animate: false }); });

  const flohmarktStaende = [
    { name: "Alte Landstr. 15", lat: 47.69016049471992, lon: 7.5602437855215285 },
    { name: "Alte Landstr. 2", lat: 47.690584900440555, lon: 7.563209032117878 },
    { name: "Alte Landstr. 22", lat: 47.68963153755825, lon: 7.560292329856701 },
    { name: "Alte Landstr. 25", lat: 47.68888343129214, lon: 7.560640429911487 },
    { name: "Alte Landstr. 25", lat: 47.68905673633853, lon: 7.560673955657406 },
    { name: "Alte Landstr. 26", lat: 47.68904288591298, lon: 7.56030647389067, angebote: "Crepes" },
    { name: "Alte Landstr. 31", lat: 47.68804710991083, lon: 7.56104655496364 },
    { name: "Alte Landstr. 4", lat: 47.69047514159541, lon: 7.56295518044662 },
    { name: "Alte Landstr. 7", lat: 47.6905144540375, lon: 7.5613861348776235, angebote: "Fleischkäsweckle" },
    { name: "Am Kirchberg 1", lat: 47.69021554676332, lon: 7.558932837535221, angebote: "Kuchen" },
    { name: "Blauenblick 19", lat: 47.68790295429244, lon: 7.559274398522493, angebote: "Candy- & Popcorn-Bar" },
    { name: "Blauenblick 38", lat: 47.6884420588935, lon: 7.558760973255757, angebote: "Muffins, Waffeln, Kaffee" },
    { name: "Blauenblick 4/2", lat: 47.68899138024774, lon: 7.559793625768729, angebote: "Burger, Muffins, Kuchen" },
    { name: "Blauenblick 5", lat: 47.68958298970196, lon: 7.559257477261469 },
    { name: "Brunnenplatz", lat: 47.69058429978339, lon: 7.560808460388324 },
    { name: "Freiburger Str. 15", lat: 47.688623672114566, lon: 7.56223727158822, angebote: "Cheesiwürscht" },
    { name: "Haselstr. 11", lat: 47.68869969977951, lon: 7.56432864030446 },
    { name: "Haselstr. 12", lat: 47.689105118843926, lon: 7.563821264767716, angebote: "Muffins" },
    { name: "Haselstr. 13", lat: 47.68857414472033, lon: 7.5642535908868265 },
    { name: "Haselstr. 22", lat: 47.68758675226322, lon: 7.5636028169938525 },
    { name: "Haselstr. 3/2", lat: 47.68999087465498, lon: 7.564345296277844 },
    { name: "Haselstr. 8", lat: 47.68940061814368, lon: 7.563928771055918 },
    { name: "Holzenweg 1", lat: 47.690601109872645, lon: 7.563604998868822 },
    { name: "Im Rumpel 1", lat: 47.689685309466704, lon: 7.561132379476176 },
    { name: "Im Rumpel 2", lat: 47.68987943584509, lon: 7.561082694133152 },
    { name: "Mühlenweg 1", lat: 47.68756672139115, lon: 7.563299394784566 },
    { name: "Mühlenweg 3", lat: 47.68738663815421, lon: 7.5628911805957735 },
    { name: "Ob der Schule 3", lat: 47.687870885771, lon: 7.559653505769753 },
    { name: "Riedstr. 2", lat: 47.69048219508826, lon: 7.5600925708940325 },
    { name: "Schulstr. 11", lat: 47.687204571058594, lon: 7.559543025108278, angebote: "Cookies, Popcorn, Zuckerwatte" },
    { name: "Schulstr. 16", lat: 47.687258427047, lon: 7.559163482061499, angebote: "Würste, Brot" },
    { name: "Schulstr. 17", lat: 47.687469641473, lon: 7.559224302334477, angebote: "Kuchen, Kaffee" },
    { name: "Schulstr. 4", lat: 47.68839595817998, lon: 7.559833571399013 },
    { name: "Steingasse 11", lat: 47.68949560136009, lon: 7.561472791550699, angebote: "Muffins, Kuchen, Lemon Soda" },
    { name: "Steingasse 17", lat: 47.689305108822005, lon: 7.561012664270406 },
    { name: "Steingasse 19", lat: 47.689405779671915, lon: 7.5607919300290565 },
    { name: "Steingasse 4", lat: 47.68983790133549, lon: 7.562357144724403, angebote: "Waffeln" },
    { name: "Steingasse 5", lat: 47.689637161162494, lon: 7.562132341017336, angebote: "Heiße Wienerle" },
    { name: "Steingasse 7", lat: 47.68969425270056, lon: 7.561840582061536 },
    { name: "Steingasse 9", lat: 47.68948503632561, lon: 7.5616450464603995 },
    { name: "Walter-Wetzel-Str. 3/1", lat: 47.68722910142015, lon: 7.562750087123431, angebote: "Essen" },
    { name: "Haselstraße 16", lat: 47.68861565376139, lon: 7.563721560460322 },
    { name: "Blauenblick 3", lat: 47.68976549086859, lon: 7.559062927868437 },
  ];

  const weitereOrte = [
    { name: "Öffentliches WC", lat: 47.690140426128096, lon: 7.562046910425782, type: "wc" },
    { name: "Öffentliches WC", lat: 47.68835671567877, lon: 7.56009401599938, type: "wc" },
    { name: "Parkplätze (an der Halle)", lat: 47.6883541622266, lon: 7.56017936336341, type: "park" }
  ];

  var standIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
    iconSize: [32,32],
    iconAnchor: [16,32],
    popupAnchor: [0,-32]
  });
  
  // Icon für Essen/Trinken
  var foodIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/5193/5193679.png',
    iconSize: [40,40],
    iconAnchor: [20,40],
    popupAnchor: [0,-40]
  });

  var wcIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/2183/2183556.png',
    iconSize: [48,48],
    iconAnchor: [24,48],
    popupAnchor: [0,-48]
  });
  var parkIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/3680/3680366.png',
    iconSize: [48,48],
    iconAnchor: [24,48],
    popupAnchor: [0,-48]
  });

  let userMarker = null;
  let lastUserPosition = null;
  let locationUpdateInterval = null;
  let positionHistory = [];
  let isLocationStabilized = false;

  function createPopupContent(item, userLat, userLon) {
    let navigationUrl = `https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lon}`;
    if (userLat && userLon) {
      navigationUrl += `&origin=${userLat},${userLon}`;
    }
    
    let content = `<b>${item.name}</b><br>`;
    if(item.angebote){
      content += `<i>${item.angebote}</i><br>`;
    }
    content += `<a href="${navigationUrl}" target="_blank">Navigation</a>`;
    return content;
  }

  function updatePopups(userLat, userLon) {
    map.eachLayer(layer => {
      if (layer instanceof L.Marker && layer.options.itemData) {
        const item = layer.options.itemData;
        layer.setPopupContent(createPopupContent(item, userLat, userLon));
      }
    });
  }

  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180;
    const Δλ = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
  }

  // Gleitender Durchschnitt für stabilere Position
  function getSmoothedPosition(newLat, newLon) {
    positionHistory.push({ lat: newLat, lon: newLon, timestamp: Date.now() });
    
    // Nur letzte 5 Positionen behalten
    if (positionHistory.length > 5) {
      positionHistory.shift();
    }
    
    // Durchschnitt berechnen
    let avgLat = 0, avgLon = 0;
    positionHistory.forEach(pos => {
      avgLat += pos.lat;
      avgLon += pos.lon;
    });
    
    return {
      lat: avgLat / positionHistory.length,
      lon: avgLon / positionHistory.length
    };
  }

  function updateUserLocation(position) {
    const rawLat = position.coords.latitude;
    const rawLon = position.coords.longitude;
    const accuracy = position.coords.accuracy;

    // Sehr strenge Genauigkeitsfilterung
    if (accuracy > 30) {
      console.log("GPS-Genauigkeit zu niedrig:", accuracy + "m");
      return;
    }

    // Geglättete Position verwenden
    const smoothed = getSmoothedPosition(rawLat, rawLon);
    const userLat = smoothed.lat;
    const userLon = smoothed.lon;

    // Nach ersten paar Messungen: Sehr hohe Schwelle für Updates
    if (lastUserPosition && isLocationStabilized) {
      const distance = calculateDistance(
        lastUserPosition.lat, lastUserPosition.lon,
        userLat, userLon
      );
      
      // Nur bei Bewegung > 15 Meter aktualisieren wenn bereits stabilisiert
      if (distance < 15) {
        return;
      }
    }

    // Bei ersten 3 Messungen: niedrigere Schwelle
    if (lastUserPosition && positionHistory.length <= 3) {
      const distance = calculateDistance(
        lastUserPosition.lat, lastUserPosition.lon,
        userLat, userLon
      );
      
      if (distance < 8) {
        return;
      }
    }

    // Position als stabilisiert markieren nach 3 Updates
    if (positionHistory.length >= 3) {
      isLocationStabilized = true;
    }

    lastUserPosition = { lat: userLat, lon: userLon };

    if (userMarker) {
      userMarker.setLatLng([userLat, userLon]);
    } else {
      userMarker = L.circleMarker([userLat, userLon], {
        radius: 10,
        fillColor: "#007bff",
        color: "#ffffff",
        weight: 3,
        opacity: 1,
        fillOpacity: 0.8,
        className: 'user-location'
      }).addTo(map).bindPopup("Dein Standort", { autoPan: false });
    }

    updatePopups(userLat, userLon);
  }

  function startLocationTracking() {
    if (!navigator.geolocation) {
      console.error("Geolocation wird nicht unterstützt");
      return;
    }

    // Erste Position mit hoher Genauigkeit
    navigator.geolocation.getCurrentPosition(
      updateUserLocation,
      function(error) {
        console.error("Fehler beim Abrufen der Position:", error);
      },
      {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      }
    );

    // Sehr seltene Updates nur alle 15 Sekunden
    locationUpdateInterval = setInterval(() => {
      navigator.geolocation.getCurrentPosition(
        updateUserLocation,
        function(error) {
          console.error("Fehler beim Aktualisieren der Position:", error);
        },
        {
          enableHighAccuracy: true,
          timeout: 8000,
          maximumAge: 60000 // 1 Minute alte Position OK
        }
      );
    }, 15000); // 15 Sekunden Intervall
  }

  // Marker für Flohmarktstände hinzufügen
  flohmarktStaende.forEach(stand => {
    // Prüfen, ob der Stand Angebote hat, die auf Essen oder Trinken hindeuten
    let iconToUse = stand.angebote ? foodIcon : standIcon;
    
    var marker = L.marker([stand.lat, stand.lon], {icon: iconToUse, itemData: stand}).addTo(map);
    marker.bindPopup(createPopupContent(stand), {
      autoPan: true,
      autoPanPadding: [20, 20],
      maxWidth: 200,
      closeButton: true
    });
  });

  // Marker für weitere Orte hinzufügen
  weitereOrte.forEach(ort => {
    let icon = ort.type === "wc" ? wcIcon : parkIcon;
    var marker = L.marker([ort.lat, ort.lon], {icon: icon, itemData: ort}).addTo(map);
    marker.bindPopup(createPopupContent(ort), {
      autoPan: true,
      autoPanPadding: [20, 20],
      maxWidth: 200,
      closeButton: true
    });
  });

  // Standortverfolgung starten
  startLocationTracking();

  // Loader ausblenden wenn Seite geladen ist
  window.addEventListener('load', function() {
    const loaderContainer = document.getElementById('loader-container');
    loaderContainer.style.opacity = '0';
    setTimeout(() => {
      loaderContainer.style.display = 'none';
    }, 500);
  });

  // Aufräumen wenn Seite verlassen wird
  window.addEventListener('beforeunload', function() {
    if (locationUpdateInterval) {
      clearInterval(locationUpdateInterval);
    }
  });
</script>

</body>
</html>
